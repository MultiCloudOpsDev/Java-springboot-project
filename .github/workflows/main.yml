name: Full CI/CD Pipeline

on:
  #push:
   # branches: [ "main" ]
  workflow_dispatch:   # âœ… Manual trigger only

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:

    # 1ï¸âƒ£ Checkout Code
    - name: Checkout Repository
      uses: actions/checkout@v4

    # 2ï¸âƒ£ Setup Java 17
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 3ï¸âƒ£ SonarQube Scan
    - name: Sonar Scan
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        mvn clean verify sonar:sonar \
        -DskipTests \
        -Dsonar.projectKey=myproject \
        -Dsonar.host.url=${{ secrets.SONAR_URL }} \
        -Dsonar.login=${{ secrets.SONAR_TOKEN }}

    # 4ï¸âƒ£ QUALITY GATE
    # - name: SonarQube Quality Gate
    #   uses: sonarsource/sonarqube-quality-gate-action@v1.1.0
    #   timeout-minutes: 5
    #   with:
    #     scanMetadataReportFile: target/site/sonar/report-task.txt
    #   env:
    #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    #     SONAR_HOST_URL: ${{ secrets.SONAR_URL }}

    # 5ï¸âƒ£ Build Backend JAR
    - name: Build Backend
      run: mvn clean package -DskipTests=true

    # 6ï¸âƒ£ Upload Backend JAR to EC2
    - name: Upload JAR
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_KEY }}
        source: "target/datastore-0.0.7.jar"
        target: "/home/ec2-user/app/"

    # 7ï¸âƒ£ Stop Old Backend
    - name: Stop Old Backend
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_KEY }}
        script: |
          PID=$(pgrep -f datastore-0.0.7.jar || true)
          if [ -n "$PID" ]; then
            sudo kill -9 $PID
          fi

    # 8ï¸âƒ£ Start New Backend
    - name: Run Backend
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_KEY }}
        script: |
          sudo mkdir -p /var/log/app
          sudo chown ec2-user:ec2-user /var/log/app
          sudo chmod 777 /var/log/app

          cd /home/ec2-user/app

          sudo nohup java -jar datastore-0.0.7.jar \
           --MYSQL_HOST="jdbc:mysql://database-2.cizuyikse7zo.us-east-1.rds.amazonaws.com:3306/datastore?createDatabaseIfNotExist=true" \
           --MYSQL_USERNAME="admin" \
           --MYSQL_PASSWORD="Rajashri123" \
           --LOG_FILE_PATH="/var/log/app/datastore.log" \
           --server.port=8084 > /var/log/app/nohup.out 2>&1 &

    # ================= FRONTEND DEPLOY =================

    # 9ï¸âƒ£ Upload Frontend Code
    - name: Upload Frontend
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_KEY }}
        source: "frontend/"
        target: "/home/ec2-user/frontend/"

    # ðŸ”Ÿ Deploy Frontend (NO PYTHON INSTALL)
    - name: Deploy Frontend
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_KEY }}
        script: |
          cd /home/ec2-user/frontend

          if [ ! -d "venv" ]; then
            python3 -m venv venv
          fi

          ./venv/bin/pip install --upgrade pip
          ./venv/bin/pip install streamlit requests

          sudo tee /etc/systemd/system/frontend.service > /dev/null <<EOF
          [Unit]
          Description=Streamlit Frontend
          After=network.target

          [Service]
          User=ec2-user
          WorkingDirectory=/home/ec2-user/frontend
          ExecStart=/home/ec2-user/frontend/venv/bin/python -m streamlit run app.py --server.port=8501 --server.address=0.0.0.0
          Environment=API_URL=http://${{ secrets.EC2_HOST }}:8084
          Restart=always

          [Install]
          WantedBy=multi-user.target
          EOF

          sudo systemctl daemon-reload
          sudo systemctl enable frontend
          sudo systemctl restart frontend
